(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9676],{6866:function(n,e,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/frontend/file-slice",function(){return r(3018)}])},3018:function(n,e,r){"use strict";r.r(e),r.d(e,{__N_SSG:function(){return c},default:function(){return _},description:function(){return b},frontMatter:function(){return d},tag:function(){return y},title:function(){return p},updated:function(){return x}});var t=r(4246),i=r(1670),s=r(53),u=r(7667),h=r(3134),a=r.n(h),l=r(7513),o=function(){var n=(0,s._)((0,u.useState)(""),2),e=n[0],r=n[1],i=(0,u.useRef)(),h=(0,s._)((0,u.useState)(null),2),o=h[0],f=h[1],c=(0,u.useCallback)(function(n){var e,t;n.target.files[0]&&(null===(e=i.current)||void 0===e||e.unsubscribe(),i.current=(t=n.target.files[0],new l.Observable(function(n){var e=new(a()).ArrayBuffer,r=Math.ceil(t.size/10485760),i=[],s=new FileReader;s.onload=function(n){e.append(n.target.result),u()},s.onerror=function(e){n.error(e)};var u=function(){if(i.length<r){var u=10485760*i.length;n.next([Math.min(1,u/t.size),null]);var h=Math.min(u+10485760,t.size),a=t.slice(u,h);s.readAsArrayBuffer(a),i.push(a)}else n.next([1,{md5:e.end(),chunks:i}]),n.complete()};return u(),{unsubscribe:function(){s.abort()}}})).subscribe(function(n){var e=(0,s._)(n,2),t=e[0],i=e[1];r((100*t).toFixed(2)),f(i)}))},[]);return(0,u.useEffect)(function(){return function(){var n;return null===(n=i.current)||void 0===n?void 0:n.unsubscribe()}},[]),(0,t.jsxs)("div",{style:{padding:"20px 0"},children:[(0,t.jsx)("input",{type:"file",onChange:c}),e?(0,t.jsxs)("div",{style:{padding:"10px 0"},children:["正在读取：",e]}):null,o?(0,t.jsxs)("div",{style:{padding:"10px 0"},children:["文件MD5值：",o.md5,"，共切分成",o.chunks.length,"个小文件"]}):null]})},f=r(5685),c=!0,d={title:"前端大文件切片上传",description:"将文件切片后上传，可以实现断点续传、暂停、秒传等操作",tag:["web前端"],updated:"2023-02-22T07:57:53.000Z"},p="前端大文件切片上传",b="将文件切片后上传，可以实现断点续传、暂停、秒传等操作",y=["web前端"],x="2023-02-22T07:57:53.000Z",g=function(n){return(0,t.jsx)(f.s,n)};function j(n){var e=Object.assign({h2:"h2",h3:"h3",pre:"pre",code:"code",p:"p",ol:"ol",li:"li",ul:"ul"},(0,i.ah)(),n.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h2,{id:"浏览器端",children:"浏览器端"}),"\n",(0,t.jsx)(e.h3,{id:"文件切片和md5值计算",children:"文件切片和MD5值计算"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"import SparkMD5 from 'spark-md5';\nimport { Observable } from 'rxjs';\n\nexport interface SlicedFile {\n  md5: string;\n  chunks: Blob[];\n}\n\nexport function fileSlice(file: File, sliceSize: number/* byte */) {\n  return new Observable<[number, SlicedFile | null]>(subscriber => {\n    const spark = new SparkMD5.ArrayBuffer();\n    const maxCount = Math.ceil(file.size / sliceSize);\n    const chunks: Blob[] = [];\n    const fileReader = new FileReader();\n    fileReader.onload = (e) => {\n      spark.append(e.target!.result as ArrayBuffer);\n      loadNext();\n    };\n    fileReader.onerror = (err) => {\n      subscriber.error(err);\n    };\n    const loadNext = () => {\n      if (chunks.length < maxCount) {\n        const start = chunks.length * sliceSize;\n        subscriber.next([Math.min(1, start / file.size), null]);\n        const end = Math.min(start + sliceSize, file.size);\n        const blob = file.slice(start, end);\n        fileReader.readAsArrayBuffer(blob);\n        chunks.push(blob);\n      } else {\n        subscriber.next([1, { md5: spark.end(), chunks }]);\n        subscriber.complete();\n      }\n    };\n    loadNext();\n    return {\n      unsubscribe() {\n        fileReader.abort();\n      },\n    };\n  });\n}\n"})}),"\n","\n",(0,t.jsx)(o,{}),"\n",(0,t.jsx)(e.h3,{id:"上传过程",children:"上传过程"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"/**\n * @type {SlicedFile}\n */\nvar slicedFile;\n(async () => {\n  for (let i = 0; i < slicedFile.chunks.length; i += 1) {\n    const formData = new FormData();\n    formData.append('file', slicedFile.chunks[i]);\n    await fetch(`/upload?md5=${slicedFile.md5}&index=${i}`, {\n      body: formData\n    });\n  }\n})();\n"})}),"\n",(0,t.jsx)(e.h3,{id:"暂停上传",children:"暂停上传"}),"\n",(0,t.jsx)(e.p,{children:"前端中断顺序上传过程的行为即为暂停，上传进度为最后一次上传成功的切片"}),"\n",(0,t.jsx)(e.h3,{id:"继续上传",children:"继续上传"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"服务端需要提供一个接口，接收参数为md5，前端通过此接口查询该md5对应的文件是否处于暂停中的状态；"}),"\n",(0,t.jsx)(e.li,{children:"如果查询到该md5对应的文件处于暂停状态，则返回前端当前暂停处于第几个切片；"}),"\n",(0,t.jsx)(e.li,{children:"前端从该切片开始，继续上传任务；"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"文件秒传",children:"文件秒传"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"前端根据md5值，通过后端接口查询该md5值对应文件的存储状态；"}),"\n",(0,t.jsx)(e.li,{children:"如果查询到该文件已经存在于文件服务器，则直接展示文件链接（根据业务需求）；"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"服务端",children:"服务端"}),"\n",(0,t.jsx)(e.h3,{id:"建立一个临时文件夹名称为用户上传文件的md5",children:"建立一个临时文件夹，名称为用户上传文件的md5"}),"\n",(0,t.jsx)(e.p,{children:"例如："}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["518798f72fea56abae47a08e0b363021（文件夹名，md5值）","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"0（第一个切片）"}),"\n",(0,t.jsx)(e.li,{children:"1（第二个切片）"}),"\n",(0,t.jsx)(e.li,{children:"2（第三个切片）"}),"\n",(0,t.jsx)(e.li,{children:"3（第四个切片）"}),"\n",(0,t.jsx)(e.li,{children:"..."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"用户暂停上传",children:"用户暂停上传"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"保留该上传任务的临时文件夹及所有已完成上传的切片文件；"}),"\n",(0,t.jsx)(e.li,{children:"可以在数据库记录当前文件的上传状态（比如暂停中），uniqueID取md5；"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"用户继续上传",children:"用户继续上传"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"查询该md5对应的文件状态是否为暂停中；"}),"\n",(0,t.jsx)(e.li,{children:"继续接收用户上传的切片；"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"用户上传成功",children:"用户上传成功"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"所有切片完成上传后，合并所有切片，并校验md5值；"}),"\n",(0,t.jsx)(e.li,{children:"存储到服务器，并更新数据库状态；"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"文件秒传-1",children:"文件秒传"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"数据库保存某个文件的md5及该文件的存储状态（比如上传成功）；"}),"\n",(0,t.jsx)(e.li,{children:"提供md5查询接口，前端根据md5查询某个文件是否存在，若存在则返回文件链接（根据业务需求）；"}),"\n"]})]})}var _=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,t.jsx)(g,Object.assign({},n,{children:(0,t.jsx)(j,n)}))}},3134:function(n){n.exports=function(n){"use strict";var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(n,e){var r=n[0],t=n[1],i=n[2],s=n[3];r+=(t&i|~t&s)+e[0]-680876936|0,s+=((r=(r<<7|r>>>25)+t|0)&t|~r&i)+e[1]-389564586|0,i+=((s=(s<<12|s>>>20)+r|0)&r|~s&t)+e[2]+606105819|0,t+=((i=(i<<17|i>>>15)+s|0)&s|~i&r)+e[3]-1044525330|0,r+=((t=(t<<22|t>>>10)+i|0)&i|~t&s)+e[4]-176418897|0,s+=((r=(r<<7|r>>>25)+t|0)&t|~r&i)+e[5]+1200080426|0,i+=((s=(s<<12|s>>>20)+r|0)&r|~s&t)+e[6]-1473231341|0,t+=((i=(i<<17|i>>>15)+s|0)&s|~i&r)+e[7]-45705983|0,r+=((t=(t<<22|t>>>10)+i|0)&i|~t&s)+e[8]+1770035416|0,s+=((r=(r<<7|r>>>25)+t|0)&t|~r&i)+e[9]-1958414417|0,i+=((s=(s<<12|s>>>20)+r|0)&r|~s&t)+e[10]-42063|0,t+=((i=(i<<17|i>>>15)+s|0)&s|~i&r)+e[11]-1990404162|0,r+=((t=(t<<22|t>>>10)+i|0)&i|~t&s)+e[12]+1804603682|0,s+=((r=(r<<7|r>>>25)+t|0)&t|~r&i)+e[13]-40341101|0,i+=((s=(s<<12|s>>>20)+r|0)&r|~s&t)+e[14]-1502002290|0,t+=((i=(i<<17|i>>>15)+s|0)&s|~i&r)+e[15]+1236535329|0,r+=((t=(t<<22|t>>>10)+i|0)&s|i&~s)+e[1]-165796510|0,s+=((r=(r<<5|r>>>27)+t|0)&i|t&~i)+e[6]-1069501632|0,i+=((s=(s<<9|s>>>23)+r|0)&t|r&~t)+e[11]+643717713|0,t+=((i=(i<<14|i>>>18)+s|0)&r|s&~r)+e[0]-373897302|0,r+=((t=(t<<20|t>>>12)+i|0)&s|i&~s)+e[5]-701558691|0,s+=((r=(r<<5|r>>>27)+t|0)&i|t&~i)+e[10]+38016083|0,i+=((s=(s<<9|s>>>23)+r|0)&t|r&~t)+e[15]-660478335|0,t+=((i=(i<<14|i>>>18)+s|0)&r|s&~r)+e[4]-405537848|0,r+=((t=(t<<20|t>>>12)+i|0)&s|i&~s)+e[9]+568446438|0,s+=((r=(r<<5|r>>>27)+t|0)&i|t&~i)+e[14]-1019803690|0,i+=((s=(s<<9|s>>>23)+r|0)&t|r&~t)+e[3]-187363961|0,t+=((i=(i<<14|i>>>18)+s|0)&r|s&~r)+e[8]+1163531501|0,r+=((t=(t<<20|t>>>12)+i|0)&s|i&~s)+e[13]-1444681467|0,s+=((r=(r<<5|r>>>27)+t|0)&i|t&~i)+e[2]-51403784|0,i+=((s=(s<<9|s>>>23)+r|0)&t|r&~t)+e[7]+1735328473|0,t+=((i=(i<<14|i>>>18)+s|0)&r|s&~r)+e[12]-1926607734|0,r+=((t=(t<<20|t>>>12)+i|0)^i^s)+e[5]-378558|0,s+=((r=(r<<4|r>>>28)+t|0)^t^i)+e[8]-2022574463|0,i+=((s=(s<<11|s>>>21)+r|0)^r^t)+e[11]+1839030562|0,t+=((i=(i<<16|i>>>16)+s|0)^s^r)+e[14]-35309556|0,r+=((t=(t<<23|t>>>9)+i|0)^i^s)+e[1]-1530992060|0,s+=((r=(r<<4|r>>>28)+t|0)^t^i)+e[4]+1272893353|0,i+=((s=(s<<11|s>>>21)+r|0)^r^t)+e[7]-155497632|0,t+=((i=(i<<16|i>>>16)+s|0)^s^r)+e[10]-1094730640|0,r+=((t=(t<<23|t>>>9)+i|0)^i^s)+e[13]+681279174|0,s+=((r=(r<<4|r>>>28)+t|0)^t^i)+e[0]-358537222|0,i+=((s=(s<<11|s>>>21)+r|0)^r^t)+e[3]-722521979|0,t+=((i=(i<<16|i>>>16)+s|0)^s^r)+e[6]+76029189|0,r+=((t=(t<<23|t>>>9)+i|0)^i^s)+e[9]-640364487|0,s+=((r=(r<<4|r>>>28)+t|0)^t^i)+e[12]-421815835|0,i+=((s=(s<<11|s>>>21)+r|0)^r^t)+e[15]+530742520|0,t+=((i=(i<<16|i>>>16)+s|0)^s^r)+e[2]-995338651|0,t=(t<<23|t>>>9)+i|0,r+=(i^(t|~s))+e[0]-198630844|0,r=(r<<6|r>>>26)+t|0,s+=(t^(r|~i))+e[7]+1126891415|0,s=(s<<10|s>>>22)+r|0,i+=(r^(s|~t))+e[14]-1416354905|0,i=(i<<15|i>>>17)+s|0,t+=(s^(i|~r))+e[5]-57434055|0,t=(t<<21|t>>>11)+i|0,r+=(i^(t|~s))+e[12]+1700485571|0,r=(r<<6|r>>>26)+t|0,s+=(t^(r|~i))+e[3]-1894986606|0,s=(s<<10|s>>>22)+r|0,i+=(r^(s|~t))+e[10]-1051523|0,i=(i<<15|i>>>17)+s|0,t+=(s^(i|~r))+e[1]-2054922799|0,t=(t<<21|t>>>11)+i|0,r+=(i^(t|~s))+e[8]+1873313359|0,r=(r<<6|r>>>26)+t|0,s+=(t^(r|~i))+e[15]-30611744|0,s=(s<<10|s>>>22)+r|0,i+=(r^(s|~t))+e[6]-1560198380|0,i=(i<<15|i>>>17)+s|0,t+=(s^(i|~r))+e[13]+1309151649|0,t=(t<<21|t>>>11)+i|0,r+=(i^(t|~s))+e[4]-145523070|0,r=(r<<6|r>>>26)+t|0,s+=(t^(r|~i))+e[11]-1120210379|0,s=(s<<10|s>>>22)+r|0,i+=(r^(s|~t))+e[2]+718787259|0,i=(i<<15|i>>>17)+s|0,t+=(s^(i|~r))+e[9]-343485551|0,t=(t<<21|t>>>11)+i|0,n[0]=r+n[0]|0,n[1]=t+n[1]|0,n[2]=i+n[2]|0,n[3]=s+n[3]|0}function t(n){var e,r=[];for(e=0;e<64;e+=4)r[e>>2]=n.charCodeAt(e)+(n.charCodeAt(e+1)<<8)+(n.charCodeAt(e+2)<<16)+(n.charCodeAt(e+3)<<24);return r}function i(n){var e,r=[];for(e=0;e<64;e+=4)r[e>>2]=n[e]+(n[e+1]<<8)+(n[e+2]<<16)+(n[e+3]<<24);return r}function s(n){var e,i,s,u,h,a,l=n.length,o=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=l;e+=64)r(o,t(n.substring(e-64,e)));for(i=(n=n.substring(e-64)).length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<i;e+=1)s[e>>2]|=n.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(r(o,s),e=0;e<16;e+=1)s[e]=0;return h=parseInt((u=(u=8*l).toString(16).match(/(.*?)(.{0,8})$/))[2],16),a=parseInt(u[1],16)||0,s[14]=h,s[15]=a,r(o,s),o}function u(n){var r;for(r=0;r<n.length;r+=1)n[r]=function(n){var r,t="";for(r=0;r<4;r+=1)t+=e[n>>8*r+4&15]+e[n>>8*r&15];return t}(n[r]);return n.join("")}function h(n){return/[\u0080-\uFFFF]/.test(n)&&(n=unescape(encodeURIComponent(n))),n}function a(n){var e,r=[],t=n.length;for(e=0;e<t-1;e+=2)r.push(parseInt(n.substr(e,2),16));return String.fromCharCode.apply(String,r)}function l(){this.reset()}return u(s("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function n(n,e){return(n=0|n||0)<0?Math.max(n+e,0):Math.min(n,e)}ArrayBuffer.prototype.slice=function(e,r){var t,i,s,u,h=this.byteLength,a=n(e,h),l=h;return(void 0!==r&&(l=n(r,h)),a>l)?new ArrayBuffer(0):(t=l-a,i=new ArrayBuffer(t),s=new Uint8Array(i),u=new Uint8Array(this,a,t),s.set(u),i)}}(),l.prototype.append=function(n){return this.appendBinary(h(n)),this},l.prototype.appendBinary=function(n){this._buff+=n,this._length+=n.length;var e,i=this._buff.length;for(e=64;e<=i;e+=64)r(this._hash,t(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},l.prototype.end=function(n){var e,r,t=this._buff,i=t.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<i;e+=1)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3);return this._finish(s,i),r=u(this._hash),n&&(r=a(r)),this.reset(),r},l.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},l.prototype.setState=function(n){return this._buff=n.buff,this._length=n.length,this._hash=n.hash,this},l.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},l.prototype._finish=function(n,e){var t,i,s,u=e;if(n[u>>2]|=128<<(u%4<<3),u>55)for(r(this._hash,n),u=0;u<16;u+=1)n[u]=0;i=parseInt((t=(t=8*this._length).toString(16).match(/(.*?)(.{0,8})$/))[2],16),s=parseInt(t[1],16)||0,n[14]=i,n[15]=s,r(this._hash,n)},l.hash=function(n,e){return l.hashBinary(h(n),e)},l.hashBinary=function(n,e){var r=u(s(n));return e?a(r):r},l.ArrayBuffer=function(){this.reset()},l.ArrayBuffer.prototype.append=function(n){var e,t,s,u=(e=this._buff.buffer,(t=new Uint8Array(e.byteLength+n.byteLength)).set(new Uint8Array(e)),t.set(new Uint8Array(n),e.byteLength),t),h=u.length;for(this._length+=n.byteLength,s=64;s<=h;s+=64)r(this._hash,i(u.subarray(s-64,s)));return this._buff=new Uint8Array(s-64<h?u.buffer.slice(s-64):0),this},l.ArrayBuffer.prototype.end=function(n){var e,r,t=this._buff,i=t.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<i;e+=1)s[e>>2]|=t[e]<<(e%4<<3);return this._finish(s,i),r=u(this._hash),n&&(r=a(r)),this.reset(),r},l.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.ArrayBuffer.prototype.getState=function(){var n,e=l.prototype.getState.call(this);return e.buff=(n=e.buff,String.fromCharCode.apply(null,new Uint8Array(n))),e},l.ArrayBuffer.prototype.setState=function(n){return n.buff=function(n,e){var r,t=n.length,i=new ArrayBuffer(t),s=new Uint8Array(i);for(r=0;r<t;r+=1)s[r]=n.charCodeAt(r);return e?s:i}(n.buff,!0),l.prototype.setState.call(this,n)},l.ArrayBuffer.prototype.destroy=l.prototype.destroy,l.ArrayBuffer.prototype._finish=l.prototype._finish,l.ArrayBuffer.hash=function(n,e){var t=u(function(n){var e,t,s,u,h,a,l=n.length,o=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=l;e+=64)r(o,i(n.subarray(e-64,e)));for(t=(n=e-64<l?n.subarray(e-64):new Uint8Array(0)).length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<t;e+=1)s[e>>2]|=n[e]<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(r(o,s),e=0;e<16;e+=1)s[e]=0;return h=parseInt((u=(u=8*l).toString(16).match(/(.*?)(.{0,8})$/))[2],16),a=parseInt(u[1],16)||0,s[14]=h,s[15]=a,r(o,s),o}(new Uint8Array(n)));return e?a(t):t},l}()},3121:function(n){"use strict";n.exports=ReactTransitionGroup},9378:function(n){"use strict";n.exports=algoliasearch},7513:function(n){"use strict";n.exports=rxjs}},function(n){n.O(0,[9894,2128,3554,5685,9774,2888,179],function(){return n(n.s=6866)}),_N_E=n.O()}]);