(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4264],{1170:function(t,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/rxjs/store",function(){return n(8026)}])},9680:function(t,e,n){"use strict";n.d(e,{t:function(){return i}});var r=n(53),o=n(7513),s=n(7667),i=function(t,e){var n=(0,r._)((0,s.useState)(),2),i=n[0],a=n[1];return(0,s.useEffect)(function(){var e=null;return i&&(e=t(i).subscribe()),function(){return null==e?void 0:e.unsubscribe()}},[i]),(0,s.useEffect)(function(){var t=new o.Subject;return a(t),function(){return t.complete()}},e),i}},3318:function(t,e,n){"use strict";n.d(e,{MT:function(){return a},X_:function(){return p},oR:function(){return l}});var r=n(2900),o=n(4923),s=n(7513),i=function(){function t(e){(0,r._)(this,t);var n=this.behavior$=new s.BehaviorSubject(e);this.state$=n.asObservable(),this.change$=this.state$.pipe((0,s.skip)(1),(0,s.distinctUntilChanged)())}var e=t.prototype;return e.map=function(t){var e=this;return(0,s.map)(function(n,r){var o=t(n,r);return e.set(o),o})},e.always=function(t){var e=this;return function(n){return n.pipe(e.map(function(){return t(e.state)}),(0,s.catchError)(function(n){return e.set(t(e.state)),(0,s.throwError)(function(){return n})}))}},e.capture=function(t){var e=this;return(0,s.catchError)(function(n,r){try{t&&e.set(t(n,e.state))}catch(t){console.error(t)}return r})},e.set=function(t){return this.behavior$.next(t),this.state},e.destroy=function(){this.behavior$.complete()},(0,o._)(t,[{key:"state",get:function(){return this.behavior$.value}},{key:"tap",get:function(){var t=this;return(0,s.tap)(function(e){return t.set(e)})}}]),t}(),a=function(t){return new i(t)},c=n(53),u=n(7667),l=function(t){var e=(0,u.useRef)((0,u.useMemo)(function(){return a(t())},[])),n=(0,c._)((0,u.useState)(t),2),r=n[0],o=n[1];return(0,u.useEffect)(function(){var t=e.current;Object.assign(t,a(t.state));var n=t.change$.subscribe(function(t){return o(t)});return function(){t.destroy(),n.unsubscribe()}},[]),[r,e.current]},p=function(t){var e=(0,c._)((0,u.useState)(t.state),2),n=e[0],r=e[1];return(0,u.useEffect)(function(){var e=t.change$.subscribe(function(t){return r(t)});return function(){return e.unsubscribe()}},[t]),n}},8026:function(t,e,n){"use strict";n.r(e),n.d(e,{__N_SSG:function(){return V},default:function(){return ta},description:function(){return tn},frontMatter:function(){return tt},tag:function(){return tr},title:function(){return te},updated:function(){return to}});var r,o,s=n(4246),i=n(1670),a=n(53),c=n(851),u=n(7149),l=n(3318),p=n(9680);function f(){var t=(0,c._)(["\n  margin-bottom: 20px;\n  & > *:not(:first-child){\n    margin-left: 10px;\n  }\n"]);return f=function(){return t},t}var h=u.ZP.div.withConfig({componentId:"sc-ce4da4fc-0"})(f()),d=function(){var t=(0,a._)((0,l.oR)(function(){return 1}),2),e=t[0],n=t[1],r=(0,p.t)(function(t){return t.pipe(n.map(function(){return n.state+1}))},[n]),o=(0,p.t)(function(t){return t.pipe(n.map(function(){return n.state-1}))},[n]);return(0,s.jsxs)(h,{children:[(0,s.jsx)("button",{onClick:function(){return null==r?void 0:r.next()},children:"增加"}),(0,s.jsx)("button",{onClick:function(){return null==o?void 0:o.next()},children:"减少"}),(0,s.jsxs)("span",{children:["count: ",e]})]})},b=n(7513);function m(){var t=(0,c._)(["\n  margin-bottom: 20px;\n  & > *:not(:first-child){\n    margin-left: 10px;\n  }\n"]);return m=function(){return t},t}var v=u.ZP.div.withConfig({componentId:"sc-192689c5-0"})(m()),x=(0,l.MT)(""),y=function(){var t=(0,l.X_)(x),e=(0,p.t)(function(t){return t.pipe((0,b.debounce)(function(){return(0,b.timer)(500)}),(0,b.switchMap)(function(t){return(0,b.of)(t).pipe((0,b.delay)(1e3*Math.random()))}),x.tap)},[]);return(0,s.jsxs)(v,{children:[(0,s.jsx)("input",{type:"text",placeholder:"请输入关键字",onChange:function(t){return null==e?void 0:e.next(t.target.value)}}),(0,s.jsxs)("span",{children:["value: ",t]})]})},g=n(7667),j=Immutable,S=n(9312);function w(t){return"function"==typeof t}var _=(r=function(t){Error.call(t),t.stack=Error().stack},(o=function(t){r(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}).prototype=Object.create(Error.prototype),o.prototype.constructor=o,o);function T(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var E=function(){var t;function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t,e,n,r,o,s=this._parentage;if(s){if(this._parentage=null,Array.isArray(s))try{for(var i=(0,S.XA)(s),a=i.next();!a.done;a=i.next())a.value.remove(this)}catch(e){t={error:e}}finally{try{a&&!a.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}else s.remove(this)}var c=this.initialTeardown;if(w(c))try{c()}catch(t){o=t instanceof _?t.errors:[t]}var u=this._finalizers;if(u){this._finalizers=null;try{for(var l=(0,S.XA)(u),p=l.next();!p.done;p=l.next()){var f=p.value;try{C(f)}catch(t){o=null!=o?o:[],t instanceof _?o=(0,S.ev)((0,S.ev)([],(0,S.CR)(o)),(0,S.CR)(t.errors)):o.push(t)}}}catch(t){n={error:t}}finally{try{p&&!p.done&&(r=l.return)&&r.call(l)}finally{if(n)throw n.error}}}if(o)throw new _(o)}},e.prototype.add=function(t){var n;if(t&&t!==this){if(this.closed)C(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(t)}}},e.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},e.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},e.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&T(e,t)},e.prototype.remove=function(t){var n=this._finalizers;n&&T(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function k(t){return t instanceof E||t&&"closed"in t&&w(t.remove)&&w(t.add)&&w(t.unsubscribe)}function C(t){w(t)?t():t.unsubscribe()}E.EMPTY;var M={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},O={setTimeout:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=O.delegate;return(null==o?void 0:o.setTimeout)?o.setTimeout.apply(o,(0,S.ev)([t,e],(0,S.CR)(n))):setTimeout.apply(void 0,(0,S.ev)([t,e],(0,S.CR)(n)))},clearTimeout:function(t){var e=O.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function $(t){O.setTimeout(function(){var e=M.onUnhandledError;if(e)e(t);else throw t})}function P(){}var F=R("C",void 0,void 0);function R(t,e,n){return{kind:t,value:e,error:n}}var N=null,A=function(t){function e(e){var n=t.call(this)||this;return n.isStopped=!1,e?(n.destination=e,k(e)&&e.add(n)):n.destination=Z,n}return(0,S.ZT)(e,t),e.create=function(t,e,n){return new U(t,e,n)},e.prototype.next=function(t){this.isStopped?X(R("N",t,void 0),this):this._next(t)},e.prototype.error=function(t){this.isStopped?X(R("E",void 0,t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?X(F,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(E),I=Function.prototype.bind;function L(t,e){return I.call(t,e)}var D=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){z(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){z(t)}else z(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){z(t)}},t}(),U=function(t){function e(e,n,r){var o,s,i=t.call(this)||this;return w(e)||!e?o={next:null!=e?e:void 0,error:null!=n?n:void 0,complete:null!=r?r:void 0}:i&&M.useDeprecatedNextContext?((s=Object.create(e)).unsubscribe=function(){return i.unsubscribe()},o={next:e.next&&L(e.next,s),error:e.error&&L(e.error,s),complete:e.complete&&L(e.complete,s)}):o=e,i.destination=new D(o),i}return(0,S.ZT)(e,t),e}(A);function z(t){M.useDeprecatedSynchronousErrorHandling?M.useDeprecatedSynchronousErrorHandling&&N&&(N.errorThrown=!0,N.error=t):$(t)}function X(t,e){var n=M.onStoppedNotification;n&&O.setTimeout(function(){return n(t,e)})}var Z={closed:!0,next:P,error:function(t){throw t},complete:P},q=function(t){function e(e,n,r,o,s,i){var a=t.call(this,e)||this;return a.onFinalize=s,a.shouldUnsubscribe=i,a._next=n?function(t){try{n(t)}catch(t){e.error(t)}}:t.prototype._next,a._error=o?function(t){try{o(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=r?function(){try{r()}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._complete,a}return(0,S.ZT)(e,t),e.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;t.prototype.unsubscribe.call(this),n||null===(e=this.onFinalize)||void 0===e||e.call(this)}},e}(A),G="function"==typeof Symbol&&Symbol.observable||"@@observable";function H(t){return t}var W=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var r,o=this,s=(r=t)&&r instanceof A||r&&w(r.next)&&w(r.error)&&w(r.complete)&&k(r)?t:new U(t,e,n);return function(t){if(M.useDeprecatedSynchronousErrorHandling){var e=!N;if(e&&(N={errorThrown:!1,error:null}),t(),e){var n=N,r=n.errorThrown,o=n.error;if(N=null,r)throw o}}else t()}(function(){var t=o.operator,e=o.source;s.add(t?t.call(s,e):e?o._subscribe(s):o._trySubscribe(s))}),s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=B(e))(function(e,r){var o=new U({next:function(e){try{t(e)}catch(t){r(t),o.unsubscribe()}},error:r,complete:e});n.subscribe(o)})},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[G]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(0===t.length?H:1===t.length?t[0]:function(e){return t.reduce(function(t,e){return e(t)},e)})(this)},t.prototype.toPromise=function(t){var e=this;return new(t=B(t))(function(t,n){var r;e.subscribe(function(t){return r=t},function(t){return n(t)},function(){return t(r)})})},t.create=function(e){return new t(e)},t}();function B(t){var e;return null!==(e=null!=t?t:M.Promise)&&void 0!==e?e:Promise}var Y="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function J(t){return new W(function(e){(function(t,e){var n,r,o,s;return(0,S.mG)(this,void 0,void 0,function(){var i;return(0,S.Jh)(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),n=(0,S.KL)(t),a.label=1;case 1:return[4,n.next()];case 2:if((r=a.sent()).done)return[3,4];if(i=r.value,e.next(i),e.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o={error:a.sent()},[3,11];case 6:if(a.trys.push([6,,9,10]),!(r&&!r.done&&(s=n.return)))return[3,8];return[4,s.call(n)];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})})(t,e).catch(function(t){return e.error(t)})})}var K=function(){var t=(0,a._)((0,l.oR)(function(){return(0,j.Map)({loading:!1,error:!1,page:1,list:[]})}),2),e=t[0],n=t[1],r=(0,g.useMemo)(function(){return e.get("list")},[e]),o=(0,g.useMemo)(function(){return e.get("page")},[e]),i=(0,p.t)(function(t){return t.pipe((0,b.switchMap)(function(t){return"cancel"===t?(0,b.of)(n.state):(0,b.of)(n.state).pipe(n.map(function(t){return t.withMutations(function(t){t.set("loading",!0),t.set("error",!1)})}),(0,b.concatMap)(function(t){var e,r,s,i;return(e="https://randomuser.me/api?page=".concat(o,"&results=10&inc=id,name,email,phone,cell,gender"),void 0===r&&(r={}),s=r.selector,i=(0,S._T)(r,["selector"]),new W(function(t){var n=new AbortController,r=n.signal,o=!0,a=i.signal;if(a){if(a.aborted)n.abort();else{var c=function(){r.aborted||n.abort()};a.addEventListener("abort",c),t.add(function(){return a.removeEventListener("abort",c)})}}var u=(0,S.pi)((0,S.pi)({},i),{signal:r}),l=function(e){o=!1,t.error(e)};return fetch(e,u).then(function(e){s?(function(t){if(t instanceof W)return t;if(null!=t){if(w(t[G]))return new W(function(e){var n=t[G]();if(w(n.subscribe))return n.subscribe(e);throw TypeError("Provided object does not correctly implement Symbol.observable")});if(t&&"number"==typeof t.length&&"function"!=typeof t)return new W(function(e){for(var n=0;n<t.length&&!e.closed;n++)e.next(t[n]);e.complete()});if(w(null==t?void 0:t.then))return new W(function(e){t.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,$)});if(Symbol.asyncIterator&&w(null==t?void 0:t[Symbol.asyncIterator]))return J(t);if(w(null==t?void 0:t[Y]))return new W(function(e){var n,r;try{for(var o=(0,S.XA)(t),s=o.next();!s.done;s=o.next()){var i=s.value;if(e.next(i),e.closed)return}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}e.complete()});if(w(null==t?void 0:t.getReader))return J(function(t){return(0,S.FC)(this,arguments,function(){var e,n,r;return(0,S.Jh)(this,function(o){switch(o.label){case 0:e=t.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,(0,S.qq)(e.read())];case 3:if(r=(n=o.sent()).value,!n.done)return[3,5];return[4,(0,S.qq)(void 0)];case 4:return[2,o.sent()];case 5:return[4,(0,S.qq)(r)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}(t))}throw TypeError("You provided "+(null!==t&&"object"==typeof t?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")})(s(e)).subscribe(new q(t,void 0,function(){o=!1,t.complete()},l,void 0)):(o=!1,t.next(e),t.complete())}).catch(l),function(){o&&n.abort()}})).pipe((0,b.switchMap)(function(t){return t.json()}),n.map(function(e){return t.set("list",e.results)}))}))}),n.always(function(t){return t.set("loading",!1)}),n.capture(function(t,e){return e.set("error",!0)}))},[o,n]),c=(0,p.t)(function(t){return t.pipe(n.map(function(){return n.state.set("page",n.state.get("page")-1)}))},[n]),u=(0,p.t)(function(t){return t.pipe(n.map(function(){return n.state.set("page",n.state.get("page")+1)}))},[n]);return(0,g.useEffect)(function(){null==i||i.next()},[i]),(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("button",{onClick:function(){return null==i?void 0:i.next()},children:(0,s.jsx)("span",{children:e.get("loading")?"刷新中...":"刷新"})}),(0,s.jsx)("button",{style:{marginLeft:10},onClick:function(){return null==i?void 0:i.next("cancel")},children:"取消请求"})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("button",{onClick:function(){return null==c?void 0:c.next()},children:"上一页"}),(0,s.jsx)("span",{children:e.get("page")}),(0,s.jsx)("button",{onClick:function(){return null==u?void 0:u.next()},children:"下一页"})]}),e.get("error")?(0,s.jsx)("p",{style:{color:"red"},children:"出错了，点击刷新按钮重新加载"}):null,(0,s.jsxs)("table",{children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"name"}),(0,s.jsx)("th",{children:"gender"}),(0,s.jsx)("th",{children:"email"}),(0,s.jsx)("th",{children:"cell"}),(0,s.jsx)("th",{children:"phone"})]})}),(0,s.jsx)("tbody",{children:r.map(function(t,e){return(0,s.jsxs)("tr",{children:[(0,s.jsxs)("td",{children:[t.name.title,". ",t.name.first," ",t.name.last]}),(0,s.jsx)("td",{children:t.gender}),(0,s.jsx)("td",{children:t.email}),(0,s.jsx)("td",{children:t.cell}),(0,s.jsx)("td",{children:t.phone})]},e)})})]})]})},Q=n(5685),V=!0,tt={title:"如何用rxjs做状态管理",description:"当rxjs遇上react",tag:["rxjs","react","web前端"],updated:"2023-02-22T07:57:53.000Z"},te="如何用rxjs做状态管理",tn="当rxjs遇上react",tr=["rxjs","react","web前端"],to="2023-02-22T07:57:53.000Z",ts=function(t){return(0,s.jsx)(Q.s,t)};function ti(t){var e=Object.assign({h1:"h1",p:"p",h2:"h2",h3:"h3",pre:"pre",code:"code",h4:"h4"},(0,i.ah)(),t.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"什么是状态管理",children:"什么是状态管理"}),"\n",(0,s.jsx)(e.p,{children:"状态管理，我们一般都称之为Store，他有点像一个始终存在并且可以让每个人都可以读取和写入的存储空间"}),"\n",(0,s.jsx)(e.h2,{id:"如何用rxjs实现一个状态管理",children:"如何用Rxjs实现一个状态管理"}),"\n",(0,s.jsx)(e.h3,{id:"核心代码",children:"核心代码"}),"\n",(0,s.jsxs)("details",{open:!0,children:[(0,s.jsx)("summary",{children:"core.ts"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { BehaviorSubject, catchError, distinctUntilChanged, map, skip, tap, throwError } from 'rxjs';\nimport type { OperatorFunction, MonoTypeOperatorFunction, Observable } from 'rxjs';\n\nexport class Store<T> {\n  private behavior$: BehaviorSubject<T>;\n  public change$: Observable<T>;\n  public state$: Observable<T>;\n  public get state() {\n    return this.behavior$.value;\n  }\n  public get tap(): MonoTypeOperatorFunction<T> {\n    return tap(v => this.set(v));\n  }\n  constructor(defaultState: T) {\n    const behavior$ = this.behavior$ = new BehaviorSubject(defaultState);\n    this.state$ = behavior$.asObservable();\n    this.change$ = this.state$.pipe(\n      skip(1),\n      distinctUntilChanged(),\n    );\n  }\n  public map<I>(fn: (input: I, index: number) => T): OperatorFunction<I, T> {\n    return map((v, index) => {\n      const ret = fn(v, index);\n      this.set(ret);\n      return ret;\n    });\n  }\n  public always<I>(fn: (input: T) => T): OperatorFunction<I, T> {\n    return source => source.pipe(\n      this.map(() => fn(this.state)),\n      catchError((err) => {\n        this.set(fn(this.state));\n        return throwError(() => err);\n      }),\n    );\n  }\n  public capture<I>(fn?: (err: any, input: T) => T): OperatorFunction<I, I> {\n    return catchError((err, caught) => {\n      try {\n        fn && this.set(fn(err, this.state));\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.error(e);\n      }\n      return caught;\n    });\n  }\n  public set(value: T) {\n    this.behavior$.next(value);\n    return this.state;\n  }\n  public destroy() {\n    this.behavior$.complete();\n  }\n}\n\nexport const createStore = <T>(defaultState: T) => {\n  return new Store(defaultState);\n};\n"})})]}),"\n",(0,s.jsx)(e.h3,{id:"react-hooks",children:"React Hooks"}),"\n",(0,s.jsxs)("details",{open:!0,children:[(0,s.jsx)("summary",{children:"hook.ts"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { type Store, createStore } from './core';\nimport { useEffect, useMemo, useRef, useState } from 'react';\n\nexport const useStore = <T>(defaultState: () => T): [T, Store<T>] => {\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const storeRef = useRef(useMemo(() => createStore(defaultState()), []));\n  const [state, setState] = useState(defaultState);\n\n  useEffect(() => {\n    const instance = storeRef.current;\n    Object.assign(instance, createStore(instance.state));\n    const subscription = instance.change$.subscribe(res => setState(res));\n    return () => {\n      instance.destroy();\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  return [state, storeRef.current];\n};\n\nexport const useGetter = <T>(store: Store<T>) => {\n  const [state, setState] = useState(store.state);\n  useEffect(() => {\n    const subscription = store.change$.subscribe(res => setState(res));\n    return () => subscription.unsubscribe();\n  }, [store]);\n  return state;\n};\n"})})]}),"\n",(0,s.jsxs)("details",{open:!0,children:[(0,s.jsx)("summary",{children:"hooks/observable.ts"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { Observable, Subject, Subscription } from 'rxjs';\nimport { DependencyList, useEffect, useState } from 'react';\n\nexport const useSubject = <T=void, O=unknown>(factory: (action: Subject<T>) => Observable<O>, deps: DependencyList) => {\n\n  const [action, setAction] = useState<Subject<T>>();\n\n  useEffect(() => {\n    let subscription: Subscription | null = null;\n    if (action) {\n      subscription = factory(action).subscribe();\n    }\n    return () => subscription?.unsubscribe();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [action]);\n\n  useEffect(() => {\n    const subject = new Subject<T>();\n    setAction(subject);\n    return () => subject.complete();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, deps);\n\n  return action;\n};\n"})})]}),"\n",(0,s.jsx)(e.h4,{id:"eslint配置",children:"eslint配置"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "rules": {\n    "react-hooks/exhaustive-deps": ["warn", {\n      "additionalHooks": "(useSubject)"\n    }]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"实战例子",children:"实战例子"}),"\n",(0,s.jsx)(e.h3,{id:"1-简单计数器",children:"1. 简单计数器"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"这是一个简单的计数器，增加或减少"})}),"\n",(0,s.jsx)(d,{}),"\n",(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"代码"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { FC } from 'react';\nimport styled from 'styled-components';\nimport { useStore } from '@shared/stores';\nimport { useSubject } from '@shared/hooks/observable';\n\nconst Wrapper = styled.div`\n  margin-bottom: 20px;\n  & > *:not(:first-child){\n    margin-left: 10px;\n  }\n`;\n\nexport const CountExample: FC = () => {\n  const [state, store] = useStore(() => 1);\n\n  const increase = useSubject((action) => action.pipe(\n    store.map(() => store.state + 1),\n  ), [store]);\n\n  const reduce = useSubject((action) => action.pipe(\n    store.map(() => store.state - 1),\n  ), [store]);\n\n  return (\n    <Wrapper>\n      <button onClick={() => increase?.next()}>增加</button>\n      <button onClick={() => reduce?.next()}>减少</button>\n      <span>count: { state }</span>\n    </Wrapper>\n  );\n};\n"})})]}),"\n",(0,s.jsx)(e.h3,{id:"2-防抖",children:"2. 防抖"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"防抖是前端经常需要用到的技术点，例如搜索框，用户在快速输入文字时，保证不会频繁的调用接口"})}),"\n",(0,s.jsx)(y,{}),"\n",(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"代码"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { FC } from 'react';\nimport styled from 'styled-components';\nimport { createStore, useGetter } from '@shared/stores';\nimport { debounce, delay, of, switchMap, timer } from 'rxjs';\nimport { useSubject } from '@shared/hooks/observable';\n\nconst Wrapper = styled.div`\n  margin-bottom: 20px;\n  & > *:not(:first-child){\n    margin-left: 10px;\n  }\n`;\n\nconst store = createStore(''); // 也可以在组件外创建，这样就可以全局共享状态数据了\n\nexport const DebounceExample: FC = () => {\n\n  const state = useGetter(store);\n\n  const action = useSubject<string>((action) => action.pipe(\n    debounce(() => timer(500)), // 500毫秒内的按键，只有最后一次会被触发\n    switchMap((res) => of(res).pipe(delay(Math.random() * 1000))), // 模拟接口返回延迟，随机 0ms - 1000ms\n    store.tap,\n  ), []);\n\n  return (\n    <Wrapper>\n      <input type=\"text\" placeholder={'请输入关键字'} onChange={e => action?.next(e.target.value)} />\n      <span>value: {state}</span>\n    </Wrapper>\n  );\n};\n"})})]}),"\n",(0,s.jsx)(e.h3,{id:"3-稍微复杂点的例子",children:"3. 稍微复杂点的例子"}),"\n",(0,s.jsx)(K,{}),"\n",(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"代码"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import { FC, useEffect, useMemo } from 'react';\nimport { Map } from 'immutable';\nimport { fromFetch } from 'rxjs/fetch';\nimport { concatMap, of, switchMap } from 'rxjs';\nimport { useStore } from '@shared/stores';\nimport { useSubject } from '@shared/hooks/observable';\n\nconst ListExample: FC = () => {\n\n  const [data, store] = useStore(() => Map({\n    loading: false,\n    error: false,\n    page: 1,\n    list: [] as any[],\n  }));\n\n  const list = useMemo(() => data.get('list') as any[], [data]);\n  const page = useMemo(() => data.get('page') as number, [data]);\n\n  const getList = useSubject<string | void>(action => action.pipe(\n    switchMap(data => {\n      if (data === 'cancel') {\n        return of(store.state);\n      }\n      return of(store.state).pipe(\n        store.map(state => state.withMutations(m => {\n          m.set('loading', true);\n          m.set('error', false);\n        })),\n        concatMap(state => fromFetch(`https://randomuser.me/api?page=${page}&results=10&inc=id,name,email,phone,cell,gender`).pipe(\n          switchMap(res => res.json()),\n          store.map(res => state.set('list', res.results)),\n        )),\n      );\n    }),\n    store.always(data => data.set('loading', false)),\n    store.capture((err, data) => data.set('error', true)),\n  ), [page, store]);\n  const previousPage = useSubject(action => action.pipe(\n    store.map(() => store.state.set('page', (store.state.get('page') as number) - 1)),\n  ), [store]);\n  const nextPage = useSubject(action => action.pipe(\n    store.map(() => store.state.set('page', (store.state.get('page') as number) + 1)),\n  ), [store]);\n\n  useEffect(() => {\n    getList?.next();\n  }, [getList]);\n\n  return (\n    <div>\n      <p>\n        <button onClick={() => getList?.next()}>\n          <span>\n            {\n              data.get('loading') ? '刷新中...' : '刷新'\n            }\n          </span>\n        </button>\n        <button style={{ marginLeft: 10 }} onClick={() => getList?.next('cancel')}>取消请求</button>\n      </p>\n      <p>\n        <button onClick={() => previousPage?.next()}>上一页</button>\n        <span>{ data.get('page') }</span>\n        <button onClick={() => nextPage?.next()}>下一页</button>\n      </p>\n      {\n        data.get('error') ? (\n          <p style={{ color: 'red' }}>出错了，点击刷新按钮重新加载</p>\n        ) : null\n      }\n      <table>\n        <thead>\n          <tr>\n            <th>name</th>\n            <th>gender</th>\n            <th>email</th>\n            <th>cell</th>\n            <th>phone</th>\n          </tr>\n        </thead>\n        <tbody>\n          {\n            list.map((v, k) => (\n              <tr key={k}>\n                <td>{v.name.title}. {v.name.first} {v.name.last}</td>\n                <td>{v.gender}</td>\n                <td>{v.email}</td>\n                <td>{v.cell}</td>\n                <td>{v.phone}</td>\n              </tr>\n            ))\n          }\n        </tbody>\n      </table>\n    </div>\n  );\n};\n\nexport { ListExample };\n"})})]})]})}var ta=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,s.jsx)(ts,Object.assign({},t,{children:(0,s.jsx)(ti,t)}))}},3121:function(t){"use strict";t.exports=ReactTransitionGroup},9378:function(t){"use strict";t.exports=algoliasearch},7513:function(t){"use strict";t.exports=rxjs}},function(t){t.O(0,[9894,2128,3554,5685,9774,2888,179],function(){return t(t.s=1170)}),_N_E=t.O()}]);